<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teckel Game</title>
    <script src="https://cdn.jsdelivr.net/npm/tinycolor2@1.4.2/dist/tinycolor-min.js"></script>
    <style>
        :root {
            --bg: #f9f9f9;
            --text: #228B22;
            --canvas-bg: #90EE90;
            --grid-color: rgba(34, 139, 34, 0.3);
            --panel-bg: rgba(255, 255, 255, 0.9);
            --panel-border: #228B22;
            --button-bg: #228B22;
            --button-text: #ffffff;
            --control-bg: #2E8B57;
            --control-shadow: rgba(0, 0, 0, 0.2);
            --control-active: #1a5f23;
        }
        .dark {
            --bg: #071016;
            --text: #90EE90;
            --canvas-bg: #06331a;
            --grid-color: rgba(46, 204, 113, 0.2);
            --panel-bg: rgba(15, 23, 32, 0.95);
            --panel-border: #2ecc71;
            --button-bg: #1f7a3a;
            --button-text: #e6ffe6;
            --control-bg: #1a5f23;
            --control-shadow: rgba(0, 0, 0, 0.4);
            --control-active: #103a1a;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s;
        }
        h1 {
            margin: 10px 0;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        #instructions {
            font-size: 14px;
            margin: 5px 0 15px;
            text-align: center;
            color: var(--text);
        }
        #scoreContainer {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin: 5px auto;
            font-size: 18px;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 10px auto;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            border: 2px solid var(--grid-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: var(--canvas-bg);
        }
        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 300px;
            height: 120px;
            margin: 15px auto;
            gap: 15px;
            padding-bottom: 20px;
        }
        .arrow {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--control-bg);
            color: var(--button-text);
            border: none;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px var(--control-shadow);
            touch-action: manipulation;
            transition: all 0.1s;
            user-select: none;
        }
        .arrow:active {
            background-color: var(--control-active);
            transform: scale(0.95);
            box-shadow: 0 2px 3px var(--control-shadow);
        }
        #pauseButton {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            font-size: 20px;
            z-index: 100;
            box-shadow: 0 3px 5px var(--control-shadow);
            transition: all 0.1s;
        }
        #pauseButton:active {
            transform: scale(0.95);
        }
        #themeToggle {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            font-size: 20px;
            z-index: 100;
            box-shadow: 0 3px 5px var(--control-shadow);
            transition: all 0.1s;
        }
        #themeToggle:active {
            transform: scale(0.95);
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .overlay-content {
            background-color: var(--panel-bg);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--panel-border);
            width: 85%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .overlay button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
            margin: 10px 5px;
            width: 100%;
            max-width: 200px;
            box-shadow: 0 2px 4px var(--control-shadow);
            transition: all 0.1s;
        }
        .overlay button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px var(--control-shadow);
        }
        #finalScore {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <button id="themeToggle" aria-label="Changer de th√®me">üåô</button>
    <button id="pauseButton" title="Pause">‚è∏</button>
    <h1>Teckel Game</h1>
    <div id="instructions">
        Penchez votre t√©l√©phone pour diriger le teckel<br>
        ou utilisez les boutons directionnels.
    </div>
    <div id="scoreContainer">
        <div id="score">Score: 0</div>
        <div id="bestScore">Meilleur: 0</div>
    </div>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>
    <div id="controls">
        <button id="up" class="arrow">‚Üë</button>
        <button id="down" class="arrow">‚Üì</button>
        <button id="left" class="arrow">‚Üê</button>
        <button id="right" class="arrow">‚Üí</button>
    </div>

    <div id="startScreen" class="overlay">
        <div class="overlay-content">
            <h2>Teckel Game</h2>
            <p>Dirigez le teckel pour manger la nourriture !<br>
            Utilisez les boutons ou penchez votre t√©l√©phone.</p>
            <button id="startButton">Jouer</button>
        </div>
    </div>
    <div id="pauseScreen" class="overlay">
        <div class="overlay-content">
            <h2>Pause</h2>
            <button id="resumeButton">Reprendre</button>
        </div>
    </div>
    <div id="gameOverScreen" class="overlay">
        <div class="overlay-content">
            <h2>Game Over !</h2>
            <div id="finalScore">Score final: 0</div>
            <button id="restartButton">Rejouer</button>
        </div>
    </div>
    <div id="motionPermissionContainer" class="overlay">
        <div class="overlay-content">
            <p>Activez les contr√¥les par mouvement pour jouer avec le gyroscope.</p>
            <button id="enableMotion">Activer</button>
        </div>
    </div>

    <script>
        // --- Variables globales ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const scoreElement = document.getElementById("score");
        const bestScoreElement = document.getElementById("bestScore");
        const finalScoreElement = document.getElementById("finalScore");
        const pauseButton = document.getElementById("pauseButton");
        const themeToggle = document.getElementById("themeToggle");
        const startScreen = document.getElementById("startScreen");
        const pauseScreen = document.getElementById("pauseScreen");
        const gameOverScreen = document.getElementById("gameOverScreen");
        const motionPermissionContainer = document.getElementById("motionPermissionContainer");
        const enableMotionBtn = document.getElementById("enableMotion");
        const startButton = document.getElementById("startButton");
        const resumeButton = document.getElementById("resumeButton");
        const restartButton = document.getElementById("restartButton");
        const upButton = document.getElementById("up");
        const downButton = document.getElementById("down");
        const leftButton = document.getElementById("left");
        const rightButton = document.getElementById("right");

        let box = 20;
        let teckel = [];
        let food = { x: 0, y: 0 };
        let score = 0;
        let bestScore = parseInt(localStorage.getItem("teckelBestScore") || "0", 10);
        let d = null;
        let gameInterval = null;
        let isPaused = false;
        let lastDirection = null;
        let allowMotion = false;
        let foodRotation = 0;
        let foodBounce = 0;
        let bounceDirection = 1;
        let isMoving = false;

        // --- Gestion du th√®me ---
        const THEME_KEY = 'teckelTheme';
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem(THEME_KEY, theme);
        }
        const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
        applyTheme(savedTheme);
        themeToggle.addEventListener('click', () => {
            applyTheme(savedTheme === 'dark' ? 'light' : 'dark');
        });

        // --- Redimensionnement du canvas (grille 20x20) ---
        function resizeCanvas() {
            const size = Math.min(window.innerWidth * 0.95, 400);
            canvas.width = size;
            canvas.height = size;
            box = size / 20;
        }
        window.addEventListener('resize', () => {
            const wasRunning = !!gameInterval && !isPaused;
            clearInterval(gameInterval);
            resizeCanvas();
            if (wasRunning) gameInterval = setInterval(drawGame, 100);
        });
        resizeCanvas();

        // --- Gestion du gyroscope ---
        let lastGamma = 0;
        let lastBeta = 0;
        const THRESHOLD = 10;
        const SMOOTHING = 0.3;

        function handleOrientation(event) {
            if (!allowMotion || isPaused || isMoving) return;
            const gamma = event.gamma * SMOOTHING + lastGamma * (1 - SMOOTHING);
            const beta = event.beta * SMOOTHING + lastBeta * (1 - SMOOTHING);
            lastGamma = gamma;
            lastBeta = beta;
            if (Math.abs(gamma) > THRESHOLD || Math.abs(beta) > THRESHOLD) {
                if (Math.abs(gamma) > Math.abs(beta)) {
                    if (gamma < -THRESHOLD && lastDirection !== "RIGHT") d = "LEFT";
                    else if (gamma > THRESHOLD && lastDirection !== "LEFT") d = "RIGHT";
                } else {
                    if (beta > THRESHOLD && lastDirection !== "DOWN") d = "UP";
                    else if (beta < -THRESHOLD && lastDirection !== "UP") d = "DOWN";
                }
            }
        }

        async function setupMotionControls() {
            if (typeof DeviceOrientationEvent !== 'undefined') {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    motionPermissionContainer.style.display = 'flex';
                    enableMotionBtn.addEventListener('click', async () => {
                        try {
                            const res = await DeviceOrientationEvent.requestPermission();
                            if (res === 'granted') {
                                allowMotion = true;
                                window.addEventListener("deviceorientation", handleOrientation);
                                motionPermissionContainer.style.display = 'none';
                            }
                        } catch (err) {
                            alert('Impossible d‚Äôactiver les contr√¥les par mouvement.');
                        }
                    });
                } else {
                    allowMotion = true;
                    window.addEventListener("deviceorientation", handleOrientation);
                }
            } else {
                alert("Les contr√¥les par mouvement ne sont pas disponibles sur cet appareil.");
            }
        }

        // --- Fonctions de jeu ---
        function resetGame() {
            teckel = [{ x: 9 * box, y: 10 * box }];
            food = {
                x: Math.floor(Math.random() * 20) * box,
                y: Math.floor(Math.random() * 20) * box
            };
            score = 0;
            scoreElement.textContent = `Score: ${score}`;
            d = null;
            lastDirection = "RIGHT";
            isPaused = false;
            pauseScreen.style.display = "none";
            gameOverScreen.style.display = "none";
            pauseButton.textContent = '‚è∏';
            foodRotation = 0;
            foodBounce = 0;
            isMoving = false;
        }

        function drawGrid() {
            const lightColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--grid-color')
                .trim();
            const darkColor = tinycolor(lightColor).darken(20).toString();

            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 20; j++) {
                    ctx.fillStyle = (i + j) % 2 === 0 ? lightColor : darkColor;
                    ctx.fillRect(i * box, j * box, box, box);
                }
            }
        }

        function drawTeckelHead(head) {
            ctx.fillStyle = "#A0522D";
            ctx.fillRect(head.x, head.y, box, box);

            ctx.fillStyle = "#8B4513";
            ctx.beginPath();
            ctx.ellipse(head.x - box*0.2, head.y + box*0.2, box*0.3, box*0.4, Math.PI/4, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(head.x + box*1.2, head.y + box*0.2, box*0.3, box*0.4, -Math.PI/4, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = "#c29467";
            ctx.beginPath();
            ctx.ellipse(head.x + box*0.5, head.y - box*0.2, box*0.4, box*0.25, 0, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(head.x + box*0.3, head.y + box*0.3, box*0.12, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(head.x + box*0.7, head.y + box*0.3, box*0.12, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = "black";
            let pupilXLeft = head.x + box*0.3;
            let pupilYLeft = head.y + box*0.3;
            let pupilXRight = head.x + box*0.7;
            let pupilYRight = head.y + box*0.3;

            if (d === "LEFT") {
                pupilXLeft -= box*0.05;
                pupilXRight -= box*0.05;
            } else if (d === "RIGHT") {
                pupilXLeft += box*0.05;
                pupilXRight += box*0.05;
            } else if (d === "UP") {
                pupilYLeft -= box*0.05;
                pupilYRight -= box*0.05;
            } else if (d === "DOWN") {
                pupilYLeft += box*0.05;
                pupilYRight += box*0.05;
            }

            ctx.beginPath();
            ctx.arc(pupilXLeft, pupilYLeft, box*0.06, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(pupilXRight, pupilYRight, box*0.06, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.ellipse(head.x + box*0.5, head.y + box*0.45, box*0.1, box*0.08, 0, 0, Math.PI*2);
            ctx.fill();
        }

        function drawFood() {
            ctx.save();
            ctx.translate(food.x + box/2, food.y + box/2 + foodBounce);
            ctx.rotate(foodRotation);
            ctx.fillStyle = "#F5DEB3";
            ctx.beginPath();
            ctx.arc(0, 0, box/2.5, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = "#D2B48C";
            ctx.beginPath();
            ctx.arc(0, 0, box/6, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
        }

        function drawGame() {
            ctx.fillStyle = getComputedStyle(document.documentElement)
                .getPropertyValue('--canvas-bg')
                .trim();
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawGrid();

            for (let i = 0; i < teckel.length - 1; i++) {
                ctx.fillStyle = "#c29467";
                ctx.fillRect(teckel[i].x, teckel[i].y, box, box);
            }

            const head = teckel[teckel.length - 1];
            drawTeckelHead(head);
            drawFood();

            foodRotation += 0.05;
            foodBounce += 0.2 * bounceDirection;
            if (foodBounce > 3 || foodBounce < -3) bounceDirection *= -1;

            if (d && !isMoving) {
                isMoving = true;
                let nextX = head.x;
                let nextY = head.y;
                if (d === "LEFT") nextX -= box;
                if (d === "RIGHT") nextX += box;
                if (d === "UP") nextY -= box;
                if (d === "DOWN") nextY += box;

                if (nextX < 0) nextX = canvas.width - box;
                if (nextX >= canvas.width) nextX = 0;
                if (nextY < 0) nextY = canvas.height - box;
                if (nextY >= canvas.height) nextY = 0;

                if (nextX === food.x && nextY === food.y) {
                    score++;
                    scoreElement.textContent = `Score: ${score}`;
                    food = {
                        x: Math.floor(Math.random() * 20) * box,
                        y: Math.floor(Math.random() * 20) * box
                    };
                    foodRotation = 0;
                    foodBounce = 0;
                } else {
                    teckel.shift();
                }

                const newHead = { x: nextX, y: nextY };
                if (collision(newHead, teckel)) {
                    clearInterval(gameInterval);
                    updateBestScore();
                    showGameOver();
                    return;
                }
                teckel.push(newHead);
                lastDirection = d;
                isMoving = false;
            }
        }

        function collision(head, array) {
            return array.some(segment => head.x === segment.x && head.y === segment.y);
        }

        function updateBestScore() {
            if (score > bestScore) {
                bestScore = score;
                bestScoreElement.textContent = `Meilleur: ${bestScore}`;
                localStorage.setItem("teckelBestScore", bestScore.toString());
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                clearInterval(gameInterval);
                pauseScreen.style.display = "flex";
                window.removeEventListener("deviceorientation", handleOrientation);
                pauseButton.textContent = '‚ñ∂Ô∏è';
            } else {
                gameInterval = setInterval(drawGame, 100);
                pauseScreen.style.display = "none";
                if (allowMotion) window.addEventListener("deviceorientation", handleOrientation);
                pauseButton.textContent = '‚è∏';
            }
        }

        function showGameOver() {
            finalScoreElement.textContent = `Score final: ${score}`;
            gameOverScreen.style.display = "flex";
            window.removeEventListener("deviceorientation", handleOrientation);
            pauseButton.textContent = '‚è∏';
        }

        // --- √âcouteurs d'√©v√©nements ---
        upButton.addEventListener("touchend", (e) => { e.preventDefault(); if (!isPaused && !isMoving && d !== "DOWN") d = "UP"; });
        downButton.addEventListener("touchend", (e) => { e.preventDefault(); if (!isPaused && !isMoving && d !== "UP") d = "DOWN"; });
        leftButton.addEventListener("touchend", (e) => { e.preventDefault(); if (!isPaused && !isMoving && d !== "RIGHT") d = "LEFT"; });
        rightButton.addEventListener("touchend", (e) => { e.preventDefault(); if (!isPaused && !isMoving && d !== "LEFT") d = "RIGHT"; });

        document.addEventListener("keydown", (e) => {
            if (e.code === 'Space' || e.keyCode === 32) {
                e.preventDefault();
                togglePause();
            } else if (!isPaused && !isMoving) {
                if (e.keyCode === 37 && d !== "RIGHT") d = "LEFT";
                else if (e.keyCode === 38 && d !== "DOWN") d = "UP";
                else if (e.keyCode === 39 && d !== "LEFT") d = "RIGHT";
                else if (e.keyCode === 40 && d !== "UP") d = "DOWN";
            }
        });

        pauseButton.addEventListener("click", togglePause);
        startButton.addEventListener("click", () => {
            startScreen.style.display = "none";
            resetGame();
            gameInterval = setInterval(drawGame, 100);
        });
        resumeButton.addEventListener("click", togglePause);
        restartButton.addEventListener("click", () => {
            gameOverScreen.style.display = "none";
            resetGame();
            gameInterval = setInterval(drawGame, 100);
        });

        // --- Initialisation ---
        setupMotionControls();
        bestScoreElement.textContent = `Meilleur: ${bestScore}`;
        startScreen.style.display = "flex";
    </script>
</body>
</html>
